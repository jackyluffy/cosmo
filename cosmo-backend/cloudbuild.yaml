# Simplified Cloud Build configuration for Cosmo Backend
steps:
  # Build Docker image
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '-t'
      - 'us-west1-docker.pkg.dev/$PROJECT_ID/cosmo-docker/cosmo-api:latest'
      - '.'
    timeout: '600s'

  # Push image to Artifact Registry
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'push'
      - 'us-west1-docker.pkg.dev/$PROJECT_ID/cosmo-docker/cosmo-api:latest'
    timeout: '300s'

  # Deploy to Cloud Run
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args:
      - 'run'
      - 'deploy'
      - 'cosmo-backend'
      - '--image'
      - 'us-west1-docker.pkg.dev/$PROJECT_ID/cosmo-docker/cosmo-api:latest'
      - '--region'
      - 'us-west1'
      - '--platform'
      - 'managed'
      - '--allow-unauthenticated'
      - '--port'
      - '8080'
      - '--memory'
      - '512Mi'
      - '--cpu'
      - '1'
      - '--min-instances'
      - '0'
      - '--max-instances'
      - '10'
      - '--concurrency'
      - '100'
      - '--timeout'
      - '60'
      - '--set-env-vars'
      - 'NODE_ENV=production,PROJECT_ID=$PROJECT_ID,FIREBASE_PROJECT_ID=cosmo-production-473621,GCLOUD_STORAGE_BUCKET=cosmo-production-473621-photos,GOOGLE_APPLICATION_CREDENTIALS_BASE64=ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAiY29zbW8tcHJvZHVjdGlvbi00NzM2MjEiLAogICJwcml2YXRlX2tleV9pZCI6ICI0ZjNjY2U5ZDNlYzEzMGVmMGExNWE2NDc5MjY5MGJmMjY0NWE0MWI4IiwKICAicHJpdmF0ZV9rZXkiOiAiLS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tXG5NSUlFdkFJQkFEQU5CZ2txaGtpRzl3MEJBUUVGQUFTQ0JLWXdnZ1NpQWdFQUFvSUJBUUNwbEdXN1kxdHdNK0NoXG5kVEl2L3h5VVQ5YlVCNTBFTFNNRytCVVVOYXh6TFdhZHR4bUlEQ2pZcDYvNDRxVFRoN1krek5FblQzSFRzNG5kXG5uY3dxVTVubnVwUnpRYzVjN3lLVllrQ1ZpRm1UQnA3SEhRMWFDaWRiMkU1ZkM3NnkwLzlQRkpmZkxFUWgzOWkvXG5ocG5QU29uSVdqYUtTTmZ0Mmxla002UCs3NVZsakhDSlhweDNOTE55Wm5wdEZYaVB1VlYwQkZ3S0Y3NVB0emcxXG5oZ2JjMnFjanpaVTNRdDhKUTB4T2dJaWkxU3ZUREpKT2NuRUEvOG1aQllRdnlzbFYxS250cEgyY3UxczlHZFJlXG5ybDdUR0Z0OTNsQ2RxR2VoMW5ld3I2T1hLMFVSRzlqWnRyK2RmR1Q5NkxzZVNYNHZnN1JFYUhJamZpRm1pcmR1XG5WTkl4VDh6TEFnTUJBQUVDZ2dFQUJRbTJtQUdVcHRtenM3aENuSEJzemU4dFI3Rk9OZUNOYU5pWDc3akVmY3Q4XG5mL1QvbWk0YVRJMTJ5ZU1aMkhyd3JCN3ptOEpkZEZlaUllWmRPV2l3YXRUOU1ndGpjUmxkb3FoL21MR3JUNVhqXG53N0NXUS9XSFE5QkNTOHFTaU1lSmp6VGlhaXZyZmtJak0xVnhYbG90aTdrNlk1TlVidW1NcndFbHZ4NHBCeEkvXG5tcVd2NTl5ZzJtZXphczVDQXJxTm4ybVEzK1JrL3l6a3BwbVN1T0FBNXRjdXRjUHBvU245cUVESGc3YnVjOW9DXG5VQzlDK1dRckJZYzJ6cXloMHpFT2pmM01IdzBMNW9TU0NBazB3eWY0aVhwcENvSWxmOXFydHZ2RzdTMWdpOUxjXG5JTnphd1hLOTNRbW1BMjAwN3hjcE1XUTIwWXVlMWFYYlJ2UkN1dUVxUVFLQmdRRGtwdjN0USszMVZCWUlmZ1EwXG5QWHE3Yy85NGFLcTJORVdEVmszSXNVZ0JoQW5OM3VOc3hBaWpuMXVYVUVlKzBKQkYzTHRzVm1XendHRWJsWTVqXG5tM2djSUV2anpWOVkyNC9jdWsrZlRGU2NCRys0OUhpcTJzZVlUMGU2Wi9WNGZCdll4VG1CQ0d5eG1JRXMrVmtvXG5Da0pnQmd0Yno3dXV2MkxFeTRCV0plOHo0UUtCZ1FDOTNLK0FsU2wxaU9BTW45TTYvTlpKekpWNzllOVk1U2ZWXG56MGZZM2t2T1o1d2hKK2VjdXROM204STZmb3FDM1ZpbENnZVk1UmYrT0JHZ3dzNksxR2sxczRkaytTWTlGSThGXG41T1hQSUJ4RytjU0QwVU80MVR4c1B1UndPWTY0QzBoU3NFem9qVDBGbWxOTXlXV1N1SUZUSG4ycTc2UnJZdE1tXG5kenpzdFVUV0t3S0JnRjhvN0tjeFRUaDd6VXV0Zm54clZjZnNCOWVKMy9wQ21PZUhKSW93MWVIam5OejBOVHhQXG4vYlJ6SHdCRFpnaVE3bXBVNmgrMWVWQXM4WDAwYWZVa2dBRmNvNWprSVJsdkQxbHlwSzZNYXU0Zm5vdWdHeFFvXG5SMGNwUDVYaHJEUi9tbXRGOForMDdOK2dzNm9QQUQ3OHZoRU9rdTJiNytWVE8zemhvTUM1dXVxaEFvR0FScklzXG4rM0VQVGYrWWhicmhlWDU2QUdMWWFwOEo3NHpzaDFXMmlBOUdKT1k1b2JMdE1GUDB0LzNjbGRGV25DSDFod2EwXG5DMytLcnBPTUpOTkUremJhc2k5V1JBZnQ4Q0orbXhBL2JoK2p4OTNyQ2JaYlJEREtYZmdSTWFTTSt3VGdla0hCXG5jWHBkOVg4Z2MyQXVuVEpzblZtbUs0Y3VMdnBPYTIxTTEwc3NCWjhDZ1lBOTZGYmlOeVo4SzZEbmM0bVBtZi9CXG5sdnduQW9uenRUckcxR1I5Nlk1alJRSVQvZ0dOUWVtTFhXT1d2aHdsNm03bm1TTWFvSm1SNE1GTk9tZUltNHZDXG42TUJQeWUzUEpNQUVBNnBqV1pHWDlDT2JnenlWNWZqMHBIZDZQL3pFcURVcDMvckhQZnRNR1F2bm96V1NpYzVmXG50RjlobUhHbFZOSG00ZkpoK0dtQ01nPT1cbi0tLS0tRU5EIFBSSVZBVEUgS0VZLS0tLS1cbiIsCiAgImNsaWVudF9lbWFpbCI6ICJmaXJlYmFzZS1hY2Nlc3NAY29zbW8tcHJvZHVjdGlvbi00NzM2MjEuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLAogICJjbGllbnRfaWQiOiAiMTAwMTIwOTg4NTY2OTM0OTkwNjIzIiwKICAiYXV0aF91cmkiOiAiaHR0cHM6Ly9hY2NvdW50cy5nb29nbGUuY29tL28vb2F1dGgyL2F1dGgiLAogICJ0b2tlbl91cmkiOiAiaHR0cHM6Ly9vYXV0aDIuZ29vZ2xlYXBpcy5jb20vdG9rZW4iLAogICJhdXRoX3Byb3ZpZGVyX3g1MDlfY2VydF91cmwiOiAiaHR0cHM6Ly93d3cuZ29vZ2xlYXBpcy5jb20vb2F1dGgyL3YxL2NlcnRzIiwKICAiY2xpZW50X3g1MDlfY2VydF91cmwiOiAiaHR0cHM6Ly93d3cuZ29vZ2xlYXBpcy5jb20vcm9ib3QvdjEvbWV0YWRhdGEveDUwOS9maXJlYmFzZS1hY2Nlc3MlNDBjb3Ntby1wcm9kdWN0aW9uLTQ3MzYyMS5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSIsCiAgInVuaXZlcnNlX2RvbWFpbiI6ICJnb29nbGVhcGlzLmNvbSIKfQo=,JWT_SECRET=gMJhRKGurkCm3s2HhasQ4kKFEc+0f/L+8pYNA1K56oHIeAKhHtyHbsiRi39tXvzBVeSk8HxTxiNw0S7aPlbGhA==,GOOGLE_CLIENT_ID=691853413697-9keo426hbtj6e469cravkt04dtq5b07t.apps.googleusercontent.com,GOOGLE_IOS_CLIENT_ID=691853413697-d3r6po74rsm6ak7vdfk51a764lnk9udv.apps.googleusercontent.com,SENDGRID_API_KEY=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,STRIPE_SECRET_KEY=sk_test_51SDbm2BIocmIX82U3c22wrm7q7BStYJgZGLynCsTiAPLAiY8bksJAqFZA199hoaoypHA0T3eYVmm8ne6i3d5PDvF00KM1mHwLm'
    timeout: '300s'

# Build configuration options
options:
  machineType: 'E2_HIGHCPU_8'
  logging: CLOUD_LOGGING_ONLY

# Timeout for entire build
timeout: '1200s'

# Tags for filtering builds
tags:
  - 'cosmo-backend'
  - 'cloud-run'